<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Floating Auto-Run Code Editor with Save</title>

  <!-- CodeMirror CSS -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/codemirror.min.css"
  />

  <style>
    html, body {
      margin: 0;
      height: 100%;
      overflow: hidden;
      font-family: sans-serif;
    }

    /* Full-window live preview */
    #preview {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      border: none;
      width: 100%;
      height: 100%;
    }

    /* Floating editor panel */
    #editor {
      position: absolute;
      top: 20px;
      left: 20px;
      width: 400px;
      height: 300px;
      background: #f7f7f7;
      border: 1px solid #ccc;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      z-index: 10;
      display: flex;
      flex-direction: column;
      resize: both;
      overflow: hidden;
    }

    /* Header with drag handle + Save button */
    #editor-header {
      background: #e2e2e2;
      padding: 6px 10px;
      cursor: move;
      user-select: none;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #editor-header button {
      background: #4caf50;
      color: #fff;
      border: none;
      padding: 4px 8px;
      border-radius: 3px;
      cursor: pointer;
      font-size: 12px;
    }

    /* CodeMirror container */
    .CodeMirror {
      flex: 1;
    }
  </style>
</head>
<body>

  <!-- Floating Editor Panel -->
  <div id="editor">
    <div id="editor-header">
      <span>Drag &amp; Resize</span>
      <button id="saveBtn">Save</button>
    </div>
    <textarea id="code">
<!DOCTYPE html>
<html>
<head>
  <style>
    h1 { color: teal; }
  </style>
</head>
<body>
  <h1>Hello World</h1>
  <script>
    console.log('Hello from JS');
  </script>
</body>
</html>
    </textarea>
  </div>

  <!-- Live Preview -->
  <iframe id="preview"></iframe>

  <!-- CodeMirror JS + Modes -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/mode/xml/xml.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/mode/javascript/javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/mode/css/css.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/mode/htmlmixed/htmlmixed.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/addon/edit/closetag.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.9/addon/edit/closebrackets.min.js"></script>

  <script>
    // Initialize CodeMirror
    const textarea = document.getElementById('code');
    const editor   = CodeMirror.fromTextArea(textarea, {
      mode: 'htmlmixed',
      lineNumbers: true,
      autoCloseTags: true,
      autoCloseBrackets: true,
      theme: 'default'
    });

    // Restore saved session if it exists
    const saved = localStorage.getItem('savedCode');
    if (saved) {
      editor.setValue(saved);
    }

    // Live render into the iframe
    function updatePreview() {
      const src = editor.getValue();
      document.getElementById('preview').srcdoc = src;
    }
    editor.on('change', updatePreview);
    window.addEventListener('load', updatePreview);

    // Save button logic
    document.getElementById('saveBtn').addEventListener('click', () => {
      localStorage.setItem('savedCode', editor.getValue());
      const btn = document.getElementById('saveBtn');
      btn.textContent = 'Saved!';
      setTimeout(() => btn.textContent = 'Save', 1500);
    });

    // Make the panel draggable
    ;(function() {
      const panel  = document.getElementById('editor');
      const header = document.getElementById('editor-header');
      let offsetX, offsetY, isDragging = false;

      header.addEventListener('mousedown', e => {
        isDragging = true;
        offsetX = e.clientX - panel.offsetLeft;
        offsetY = e.clientY - panel.offsetTop;
        document.body.style.userSelect = 'none';
      });
      document.addEventListener('mousemove', e => {
        if (!isDragging) return;
        panel.style.left = `${e.clientX - offsetX}px`;
        panel.style.top  = `${e.clientY - offsetY}px`;
      });
      document.addEventListener('mouseup', () => {
        isDragging = false;
        document.body.style.userSelect = '';
      });
    })();

    // Keep CodeMirror resized to fill the panel
    new ResizeObserver(() => {
      editor.setSize('100%', 'calc(100% - 0px)');
    }).observe(document.getElementById('editor'));
  </script>

</body>
</html>